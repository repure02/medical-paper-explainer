<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Medical Paper Explainer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <h1>Medical Paper Explainer</h1>
    <p class="subtitle">
        Upload a medical research paper or paste text to get an explanation tailored to your level.
    </p>

    <form method="post" enctype="multipart/form-data" class="upload-form">

        <p style="color:#555; font-size:14px;">
            You can either upload a PDF or paste the text directly.
        </p>

        <!-- PDF Upload -->
        <label for="file">Upload PDF</label>
        <input type="file" name="file" accept=".pdf">

        <!-- Text Input -->
        <label for="text">Or paste your text</label>
        <textarea 
            name="text" 
            rows="6" 
            placeholder="Paste medical abstract, section, or full text here..."
        ></textarea>

        <!-- Level -->
        <label for="level">Explanation level</label>
        <select name="level" required>
            <option value="beginner">Beginner (no medical background)</option>
            <option value="intermediate">Intermediate (some medical knowledge)</option>
            <option value="expert">Expert (research level)</option>
        </select>

        <button type="submit">Explain</button>
    </form>

    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}

    {% if explanation %}
        <div class="result">
            <h2>{{ level.capitalize() }} Explanation</h2>
            <div 
                class="explanation-box" 
                id="explanation-box" 
                data-fulltext="{{ explanation|e }}">
            </div>
        </div>
    {% endif %}

    {% if sources %}
        <div class="sources">
            <h3>Sources</h3>

            {% for s in sources %}
                <details class="source-item" id="source-{{ s.chunk_id }}">
                    <summary>
                        Chunk {{ s.chunk_id }} â€” page {{ s.page }}
                    </summary>
                    <div class="source-text">{{ s.text }}</div>
                </details>
            {% endfor %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const box = document.getElementById("explanation-box");
  if (!box) return;

  const fullText = (box.dataset.fulltext || "").trim();

  // Turn <<12>> into a link that points to the source block
  const withLinks = fullText.replace(/<<(\d+)>>/g, (match, id) => {
    return `<a href="#source-${id}" class="citation" data-chunk="${id}"><<${id}>></a>`;
  });

  box.innerHTML = withLinks;

  // Make citation clicks open the <details> and scroll smoothly
  box.addEventListener("click", function(e) {
    const link = e.target.closest(".citation");
    if (!link) return;

    e.preventDefault();

    const id = link.dataset.chunk;
    const target = document.getElementById(`source-${id}`);
    if (!target) return;

    // If it's a <details>, open it
    if (target.tagName.toLowerCase() === "details") {
      target.open = true;
    }

    target.scrollIntoView({ behavior: "smooth", block: "start" });
    // Highlight the target briefly
    target.classList.add("highlight");
    setTimeout(() => target.classList.remove("highlight"), 1200);

    // Update URL hash
    history.replaceState(null, "", `#source-${id}`);
  });
});
</script>

</body>
</html>
